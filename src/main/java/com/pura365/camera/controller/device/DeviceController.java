package com.pura365.camera.controller.device;

import com.pura365.camera.model.ApiResponse;
import com.pura365.camera.model.device.*;
import com.pura365.camera.service.DeviceService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;

/**
 * 设备管理控制器
 * <p>
 * 提供App端设备相关的HTTP接口，包括：
 * <ul>
 *     <li>设备列表查询</li>
 *     <li>设备详情查询</li>
 *     <li>添加/绑定设备</li>
 *     <li>删除/解绑设备</li>
 *     <li>更新设备信息</li>
 *     <li>设备设置管理</li>
 *     <li>本地录像列表</li>
 *     <li>云台PTZ控制</li>
 * </ul>
 *
 * @author camera-server
 */
@Tag(name = "设备管理", description = "设备增删改查、设置、录像、云台控制等管理接口")
@RestController
@RequestMapping("/api/device/devices")
public class DeviceController {

    private static final Logger log = LoggerFactory.getLogger(DeviceController.class);

    /**
     * HTTP状态码：请求参数错误
     */
    private static final int HTTP_BAD_REQUEST = 400;

    /**
     * HTTP状态码：无权限
     */
    private static final int HTTP_FORBIDDEN = 403;

    /**
     * HTTP状态码：资源不存在
     */
    private static final int HTTP_NOT_FOUND = 404;

    /**
     * HTTP状态码：服务器内部错误
     */
    private static final int HTTP_INTERNAL_ERROR = 500;

    /**
     * 错误消息：设备不存在
     */
    private static final String MSG_DEVICE_NOT_FOUND = "设备不存在";

    /**
     * 错误消息：无权操作该设备
     */
    private static final String MSG_NO_PERMISSION = "无权操作该设备";

    /**
     * 错误消息：设备ID不能为空
     */
    private static final String MSG_DEVICE_ID_REQUIRED = "设备ID不能为空";

    /**
     * 错误消息：方向参数不能为空
     */
    private static final String MSG_DIRECTION_REQUIRED = "方向参数不能为空";

    @Autowired
    private DeviceService deviceService;

    /**
     * 获取当前用户的设备列表
     *
     * @param currentUserId 当前登录用户ID（由拦截器注入）
     * @return 设备列表
     */
    @Operation(summary = "获取设备列表", description = "获取当前用户绑定的所有设备")
    @GetMapping
    public ApiResponse<List<DeviceListItemVO>> listDevices(
            @RequestAttribute("currentUserId") Long currentUserId) {

        List<DeviceListItemVO> devices = deviceService.listDevices(currentUserId);
        return ApiResponse.success(devices);
    }

    /**
     * 获取设备详情
     *
     * @param currentUserId 当前登录用户ID
     * @param deviceId      设备ID
     * @return 设备详细信息
     */
    @Operation(summary = "获取设备详情", description = "获取指定设备的详细信息，包括设置、云存储状态等")
    @GetMapping("/{id}/info")
    public ApiResponse<DeviceDetailVO> getDeviceInfo(
            @RequestAttribute("currentUserId") Long currentUserId,
            @Parameter(description = "设备ID") @PathVariable("id") String deviceId) {

        DeviceDetailVO detail = deviceService.getDeviceDetail(currentUserId, deviceId);
        if (detail == null) {
            return ApiResponse.error(HTTP_NOT_FOUND, MSG_DEVICE_NOT_FOUND);
        }
        return ApiResponse.success(detail);
    }

    /**
     * 添加/绑定设备
     *
     * @param currentUserId 当前登录用户ID
     * @param request       添加设备请求参数
     * @return 添加后的设备基础信息
     */
    @Operation(summary = "添加设备", description = "将设备绑定到当前用户，如果设备不存在则自动创建")
    @PostMapping("/add")
    public ApiResponse<DeviceVO> addDevice(
            @RequestAttribute("currentUserId") Long currentUserId,
            @Valid @RequestBody AddDeviceRequest request) {

        // 参数校验
        if (!StringUtils.hasText(request.getDeviceId())) {
            return ApiResponse.error(HTTP_BAD_REQUEST, MSG_DEVICE_ID_REQUIRED);
        }

        DeviceVO device = deviceService.addDevice(currentUserId, request);
        return ApiResponse.success(device);
    }

    /**
     * 删除/解绑设备
     *
     * @param currentUserId 当前登录用户ID
     * @param deviceId      设备ID
     * @return 空响应
     */
    @Operation(summary = "删除设备", description = "解除当前用户与指定设备的绑定关系")
    @DeleteMapping("/{id}")
    public ApiResponse<Void> deleteDevice(
            @RequestAttribute("currentUserId") Long currentUserId,
            @Parameter(description = "设备ID") @PathVariable("id") String deviceId) {

        deviceService.deleteDevice(currentUserId, deviceId);
        return ApiResponse.success(null);
    }

    /**
     * 更新设备信息
     *
     * @param currentUserId 当前登录用户ID
     * @param deviceId      设备ID
     * @param request       更新请求参数
     * @return 更新后的设备信息
     */
    @Operation(summary = "更新设备信息", description = "更新设备的基础信息，目前支持修改设备名称")
    @PutMapping("/{id}")
    public ApiResponse<DeviceVO> updateDevice(
            @RequestAttribute("currentUserId") Long currentUserId,
            @Parameter(description = "设备ID") @PathVariable("id") String deviceId,
            @Valid @RequestBody UpdateDeviceRequest request) {

        DeviceVO device = deviceService.updateDevice(deviceId, request);
        if (device == null) {
            return ApiResponse.error(HTTP_NOT_FOUND, MSG_DEVICE_NOT_FOUND);
        }
        return ApiResponse.success(device);
    }

    /**
     * 获取本地录像列表
     *
     * @param currentUserId 当前登录用户ID
     * @param deviceId      设备ID
     * @param date          日期过滤（可选，格式：yyyy-MM-dd）
     * @param page          页码（从1开始，默认1）
     * @param pageSize      每页数量（默认20）
     * @return 分页的录像列表
     */
    @Operation(summary = "获取本地录像列表", description = "获取设备TF卡上的本地录像列表，支持按日期过滤和分页")
    @GetMapping("/{id}/local-videos")
    public ApiResponse<LocalVideoPageVO> listLocalVideos(
            @RequestAttribute("currentUserId") Long currentUserId,
            @Parameter(description = "设备ID") @PathVariable("id") String deviceId,
            @Parameter(description = "日期过滤，格式：yyyy-MM-dd") @RequestParam(value = "date", required = false) String date,
            @Parameter(description = "页码，从1开始") @RequestParam(value = "page", required = false, defaultValue = "1") int page,
            @Parameter(description = "每页数量") @RequestParam(value = "page_size", required = false, defaultValue = "20") int pageSize) {

        LocalVideoPageVO result = deviceService.listLocalVideos(currentUserId, deviceId, date, page, pageSize);
        if (result == null) {
            return ApiResponse.error(HTTP_FORBIDDEN, MSG_NO_PERMISSION);
        }
        return ApiResponse.success(result);
    }

    /**
     * 云台PTZ控制
     *
     * @param currentUserId 当前登录用户ID
     * @param deviceId      设备ID
     * @param request       云台控制请求
     * @return 空响应
     */
    @Operation(summary = "云台控制", description = "控制设备云台转动方向，支持上下左右及停止")
    @PostMapping("/{id}/ptz")
    public ApiResponse<Void> ptzControl(
            @RequestAttribute("currentUserId") Long currentUserId,
            @Parameter(description = "设备ID") @PathVariable("id") String deviceId,
            @Valid @RequestBody PtzControlRequest request) {

        // 参数校验
        if (!StringUtils.hasText(request.getDirection())) {
            return ApiResponse.error(HTTP_BAD_REQUEST, MSG_DIRECTION_REQUIRED);
        }

        try {
            Boolean result = deviceService.sendPtzCommand(currentUserId, deviceId, request);
            if (result == null) {
                return ApiResponse.error(HTTP_FORBIDDEN, MSG_NO_PERMISSION);
            }
            return ApiResponse.success(null);
        } catch (Exception e) {
            log.error("发送PTZ指令失败, deviceId={}, direction={}", deviceId, request.getDirection(), e);
            return ApiResponse.error(HTTP_INTERNAL_ERROR, "发送PTZ指令失败: " + e.getMessage());
        }
    }
}
