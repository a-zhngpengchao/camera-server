package com.pura365.camera.controller.app;

import com.pura365.camera.model.ApiResponse;
import com.pura365.camera.service.AuthService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

/**
 * App 认证相关接口
 * 
 * 包含：
 * - 用户注册
 * - 账号密码登录
 * - Token刷新
 * - 登出
 * - 第三方登录（微信/Apple/Google）
 * - 短信登录（待实现）
 */
@RestController
@RequestMapping("/auth")
public class AuthController {

    private static final Logger log = LoggerFactory.getLogger(AuthController.class);

    @Autowired
    private AuthService authService;

    /**
     * 用户注册（账号密码）
     */
    @PostMapping("/register")
    public ApiResponse<Map<String, Object>> register(@RequestBody Map<String, String> body) {
        String username = body.get("username");
        String phone = body.get("phone");
        String email = body.get("email");
        String password = body.get("password");
        try {
            Map<String, Object> data = authService.registerByPassword(username, phone, email, password);
            return ApiResponse.success(data);
        } catch (RuntimeException e) {
            log.warn("注册失败: {}", e.getMessage());
            return ApiResponse.error(400, e.getMessage());
        } catch (Exception e) {
            log.error("注册异常", e);
            return ApiResponse.error(500, "服务器错误");
        }
    }

    /**
     * 账号密码登录
     */
    @PostMapping("/login/password")
    public ApiResponse<Map<String, Object>> loginByPassword(@RequestBody Map<String, String> body) {
        String account = body.get("account");
        String password = body.get("password");
        if (account == null || account.isEmpty() || password == null || password.isEmpty()) {
            return ApiResponse.error(400, "account 和 password 不能为空");
        }
        try {
            Map<String, Object> data = authService.loginByPassword(account, password);
            return ApiResponse.success(data);
        } catch (RuntimeException e) {
            log.warn("密码登录失败: {}", e.getMessage());
            return ApiResponse.error(401, e.getMessage());
        } catch (Exception e) {
            log.error("密码登录异常", e);
            return ApiResponse.error(500, "服务器错误");
        }
    }

    /**
     * 刷新 Token
     */
    @PostMapping("/token/refresh")
    public ApiResponse<Map<String, Object>> refreshToken(@RequestBody Map<String, String> body) {
        String refreshToken = body.get("refresh_token");
        if (refreshToken == null || refreshToken.isEmpty()) {
            return ApiResponse.error(400, "refresh_token 不能为空");
        }
        try {
            Map<String, Object> data = authService.refreshToken(refreshToken);
            return ApiResponse.success(data);
        } catch (RuntimeException e) {
            return ApiResponse.error(401, e.getMessage());
        } catch (Exception e) {
            log.error("刷新 token 异常", e);
            return ApiResponse.error(500, "服务器错误");
        }
    }

    /**
     * 登出（可选带 refresh_token，用于精确注销）
     */
    @PostMapping("/logout")
    public ApiResponse<Void> logout(@RequestHeader(value = "X-User-Id", required = false) Long userId,
                                    @RequestBody(required = false) Map<String, String> body) {
        String refreshToken = body != null ? body.get("refresh_token") : null;
        try {
            authService.logout(userId, refreshToken);
            return ApiResponse.success(null);
        } catch (Exception e) {
            log.error("登出异常", e);
            return ApiResponse.error(500, "服务器错误");
        }
    }

    // ===================== 第三方登录 =====================

    /**
     * 微信登录
     * 请求体：{ "code": "微信授权码" }
     */
    @PostMapping("/login/wechat")
    public ApiResponse<Map<String, Object>> loginByWeChat(@RequestBody Map<String, String> body) {
        String code = body.get("code");
        if (code == null || code.isEmpty()) {
            return ApiResponse.error(400, "code 不能为空");
        }
        try {
            Map<String, Object> data = authService.loginByWeChat(code);
            return ApiResponse.success(data);
        } catch (RuntimeException e) {
            log.warn("微信登录失败: {}", e.getMessage());
            return ApiResponse.error(401, e.getMessage());
        } catch (Exception e) {
            log.error("微信登录异常", e);
            return ApiResponse.error(500, "服务器错误");
        }
    }

    /**
     * Apple 登录
     * 请求体：{
     *   "identity_token": "Apple Identity Token (JWT)",
     *   "first_name": "名（首次登录时可选）",
     *   "last_name": "姓（首次登录时可选）",
     *   "email": "邮箱（首次登录时可选）"
     * }
     */
    @PostMapping("/login/apple")
    public ApiResponse<Map<String, Object>> loginByApple(@RequestBody Map<String, String> body) {
        String identityToken = body.get("identity_token");
        if (identityToken == null || identityToken.isEmpty()) {
            return ApiResponse.error(400, "identity_token 不能为空");
        }
        try {
            // 提取可能的用户信息（首次登录时 Apple 会返回）
            Map<String, String> userInfo = new java.util.HashMap<>();
            if (body.get("first_name") != null) {
                userInfo.put("firstName", body.get("first_name"));
            }
            if (body.get("last_name") != null) {
                userInfo.put("lastName", body.get("last_name"));
            }
            if (body.get("email") != null) {
                userInfo.put("email", body.get("email"));
            }

            Map<String, Object> data = authService.loginByApple(identityToken, userInfo.isEmpty() ? null : userInfo);
            return ApiResponse.success(data);
        } catch (RuntimeException e) {
            log.warn("Apple 登录失败: {}", e.getMessage());
            return ApiResponse.error(401, e.getMessage());
        } catch (Exception e) {
            log.error("Apple 登录异常", e);
            return ApiResponse.error(500, "服务器错误");
        }
    }

    /**
     * Google 登录
     * 请求体：{
     *   "id_token": "Google ID Token (JWT)",
     *   "platform": "ios / android / web（可选，默认 web）"
     * }
     */
    @PostMapping("/login/google")
    public ApiResponse<Map<String, Object>> loginByGoogle(@RequestBody Map<String, String> body) {
        String idToken = body.get("id_token");
        if (idToken == null || idToken.isEmpty()) {
            return ApiResponse.error(400, "id_token 不能为空");
        }
        String platform = body.get("platform");
        if (platform == null || platform.isEmpty()) {
            platform = "web";
        }
        try {
            Map<String, Object> data = authService.loginByGoogle(idToken, platform);
            return ApiResponse.success(data);
        } catch (RuntimeException e) {
            log.warn("Google 登录失败: {}", e.getMessage());
            return ApiResponse.error(401, e.getMessage());
        } catch (Exception e) {
            log.error("Google 登录异常", e);
            return ApiResponse.error(500, "服务器错误");
        }
    }

    @PostMapping("/sms/send")
    public ApiResponse<Void> sendSms(@RequestBody Map<String, String> body) {
        return ApiResponse.error(501, "短信发送暂未实现");
    }

    @PostMapping("/login/sms")
    public ApiResponse<Map<String, Object>> loginBySms(@RequestBody Map<String, String> body) {
        return ApiResponse.error(501, "短信登录暂未实现");
    }
}

